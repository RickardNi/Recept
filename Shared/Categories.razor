@page "/categories"
@inject RecipeService RecipeService

@if (isLoading)
{
    <p>Laddar recept...</p>
}
else
{
    <div class="categories-layout">
        <aside class="categories-sidebar">
            <ul class="category-list">
                @foreach (var category in categories)
                {
                    <li>
                        <button class="category-item @(selectedCategory == category ? "active" : "")"
                                @onclick="() => SelectCategory(category)">
                            @if (CategoryIconCatalog.Icons.TryGetValue(category, out var icon))
                            {
                                @((MarkupString)icon)
                            }
                            @category
                        </button>
                    </li>
                }
            </ul>
        </aside>
        <div class="categories-recipes">
            <h1 class="categories-heading">@selectedCategory</h1>
            @if (filteredRecipes.Count == 0)
            {
                <p>Inga recept i den h√§r kategorin.</p>
            }
            else
            {
                <ul class="recipe-list">
                    @foreach (var recipe in filteredRecipes.OrderBy(r => r.Title))
                    {
                        <li>
                            <a href="/recipe/@recipe.Slug">@recipe.Title</a>
                        </li>
                    }
                </ul>
            }
        </div>
    </div>
}

@code {
    private List<RecipeMetadata> allRecipes = new();
    private List<string> categories = new();
    private List<RecipeMetadata> filteredRecipes = new();
    private string selectedCategory = string.Empty;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            allRecipes = await RecipeService.GetAllRecipesAsync();
            categories = allRecipes
                .SelectMany(r => r.Categories)
                .Distinct()
                .OrderBy(c => c)
                .ToList();

            if (categories.Count > 0)
                SelectCategory(categories[0]);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void SelectCategory(string category)
    {
        selectedCategory = category;
        filteredRecipes = allRecipes
            .Where(r => r.Categories.Contains(category))
            .ToList();
    }
}