@page "/"
@inject RecipeService RecipeService
@inject ISettingsStorage SettingsStorage

<PageTitle>Recept</PageTitle>

<section class="home-page">
	<section>
		<p class="home-intro">Välkommen till min samling av recept för vardag och helg. Här hittar du rätter jag återkommer till, med fokus på tydliga instruktioner och sådant som faktiskt fungerar i ett vanligt kök.</p>
	</section>

	@if (isLoading)
	{
		<p>Laddar startsidan...</p>
	}
	else
	{
		@if (favoriteRecipes.Count > 0)
		{
			<section class="home-highlights" aria-labelledby="home-favorites-heading">
				<h1 id="home-favorites-heading">Favoriter</h1>
				<ul class="home-list">
					@foreach (var recipe in favoriteRecipes)
					{
						<li>
							<a class="recipe-link-with-favorite" href="recipe/@recipe.Slug">
								<span class="recipe-favorite-indicator is-favorite" aria-hidden="true">
									@((MarkupString)IconCatalog.FavoriteHeartSvg(18))
								</span>
								<span>@recipe.Title</span>
							</a>
						</li>
					}
				</ul>
			</section>
		}

		<section class="home-highlights" aria-labelledby="home-recent-heading">
			<h1 id="home-recent-heading">Senast tillagda</h1>
			@if (recentRecipes.Count == 0)
			{
				<p>Inga nya recept ännu.</p>
			}
			else
			{
				<ul class="home-list">
					@foreach (var recipe in recentRecipes)
					{
						<li>
							<a class="recipe-link-with-favorite" href="recipe/@recipe.Slug">
								<span class="recipe-favorite-indicator @(IsFavorite(recipe.Slug) ? "is-favorite" : "")" aria-hidden="true">
									@((MarkupString)IconCatalog.FavoriteHeartSvg(18))
								</span>
								<span>@recipe.Title</span>
							</a>
						</li>
					}
				</ul>
			}
		</section>
	}

	<section>
		<Categories />
	</section>
</section>

@code {
	private List<RecipeMetadata> favoriteRecipes = new();
	private List<RecipeMetadata> recentRecipes = new();
	private HashSet<string> favoriteSlugSet = new(StringComparer.OrdinalIgnoreCase);
	private bool isLoading = true;

	protected override async Task OnInitializedAsync()
	{
		try
		{
			var allRecipes = await RecipeService.GetAllRecipesAsync();
			var favoriteSlugs = await SettingsStorage.GetSettingAsync<List<string>>(LocalStorageSettings.FavoriteRecipeSlugs) ?? [];
			favoriteSlugSet = favoriteSlugs
				.Distinct(StringComparer.OrdinalIgnoreCase)
				.ToHashSet(StringComparer.OrdinalIgnoreCase);
			var favoriteOrder = favoriteSlugs
				.Distinct(StringComparer.OrdinalIgnoreCase)
				.Select((slug, index) => new { slug, index })
				.ToDictionary(x => x.slug, x => x.index, StringComparer.OrdinalIgnoreCase);

			favoriteRecipes = allRecipes
				.Where(recipe => favoriteOrder.ContainsKey(recipe.Slug))
				.OrderBy(recipe => favoriteOrder[recipe.Slug])
				.ToList();

			recentRecipes = allRecipes
				.OrderByDescending(recipe => recipe.Created ?? DateOnly.MinValue)
				.Take(5)
				.ToList();
		}
		finally
		{
			isLoading = false;
		}
	}

	private bool IsFavorite(string slug)
	{
		return favoriteSlugSet.Contains(slug);
	}
}

